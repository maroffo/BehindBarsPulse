{% extends "base.html" %}

{% block title %}BehindBars - {{ newsletter.title if newsletter else "Newsletter sul Sistema Carcerario" }}{% endblock %}

{% block content %}
{% if newsletter %}
<article class="newsletter">
    <header class="newsletter-header">
        <time class="newsletter-date" datetime="{{ newsletter.issue_date }}">
            {{ newsletter.issue_date.strftime('%d %B %Y') }}
        </time>
        <h1 class="newsletter-title">{{ newsletter.title }}</h1>
        <p class="newsletter-subtitle">{{ newsletter.subtitle }}</p>
    </header>

    <section class="newsletter-opening editorial">
        {{ newsletter.opening | replace('\n\n', '</p><p>') | replace('\n', '<br>') | sanitize }}
    </section>

    <hr class="divider-strong">

    {% if newsletter.press_review %}
    <section class="press-review">
        <h2 class="section-title">Rassegna Stampa</h2>

        {% for category in newsletter.press_review %}
        <div class="category">
            <h3 class="category-title">{{ category.category }}</h3>
            {% if category.comment %}
            <p class="category-comment">{{ category.comment }}</p>
            {% endif %}

            <div class="article-links">
                {% for article in category.articles %}
                <div class="article-link">
                    <p class="article-link-title">
                        <a href="{{ article.link }}" target="_blank" rel="noopener">{{ article.title }}</a>
                    </p>
                    <p class="article-link-meta">
                        {% if article.author %}{{ article.author }}{% endif %}
                        {% if article.author and article.source %} · {% endif %}
                        {% if article.source %}{{ article.source }}{% endif %}
                        {% if (article.author or article.source) and article.published_date %} · {% endif %}
                        {% if article.published_date %}{{ article.published_date | format_date }}{% endif %}
                    </p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </section>
    {% elif newsletter.html_content %}
    {# Fallback: show original HTML in iframe for imported newsletters without structured data #}
    <section class="press-review imported-content">
        <iframe
            srcdoc="{{ newsletter.html_content | e }}"
            class="newsletter-iframe"
            title="Newsletter {{ newsletter.issue_date }}"
            sandbox="allow-popups allow-popups-to-escape-sandbox"
        ></iframe>
    </section>
    {% endif %}

    <section class="newsletter-closing">
        <div class="closing-box">
            {{ newsletter.closing | replace('\n\n', '</p><p>') | replace('\n', '<br>') | sanitize }}
        </div>
    </section>
</article>

{% else %}
<div class="empty-state">
    <h1>Nessuna newsletter disponibile</h1>
    <p>La newsletter di oggi non è ancora stata pubblicata.</p>
    <a href="/archive" class="btn">Consulta l'archivio</a>
</div>
{% endif %}
{% endblock %}
